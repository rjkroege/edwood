#!/bin/bash
# Ralph Wiggum's Plan Iterator
# "I'm helping!"

PLAN_FILE="${1:-PLAN.md}"
MAX_STEPS="${2:-20}"

# Ralph's wisdom arrays
GREETINGS=(
    "Hi, Super Nintendo Chalmers!"
    "I'm learnding!"
    "My cat's breath smells like cat food."
    "I found a moon rock in my nose!"
)

WORKING=(
    "I'm helping!"
    "I choo-choo-choose this task!"
    "It tastes like... productivity!"
    "The leprechaun told me to work on this."
    "I bent my wookie doing this!"
)

DONE_QUOTES=(
    "I done did it!"
    "Me finish task? That's unpossible! Wait, I did it!"
    "I'm Idaho! Also, I'm done!"
    "My brain is full of smart juice now!"
)

EMPTY=(
    "There's no more tasks. I sleep in a drawer now!"
    "All done! Principal Skinner, I got carsick in your office."
    "The deep end is empty, like my task list!"
)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Print random greeting
idx=$((RANDOM % ${#GREETINGS[@]}))
echo -e "${YELLOW}${GREETINGS[$idx]}${NC}"
echo ""

if [[ ! -f "$PLAN_FILE" ]]; then
    echo -e "${RED}Me fail find file? That's unpossible!${NC}"
    echo "Can't find: $PLAN_FILE"
    exit 1
fi

MAX_PASSES="$MAX_STEPS"
pass_count=0

# Main loop - iterate through tasks
while [[ $pass_count -lt $MAX_PASSES ]]; do
    pass_count=$((pass_count + 1))

    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${MAGENTA}Pass $pass_count of $MAX_PASSES${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Find current section (look for ### headers before first unchecked item)
    current_section=""
    current_phase=""
    next_task=""
    next_stage=""

    while IFS= read -r line; do
        # Track phase headers (## Phase X: Name)
        if [[ "$line" =~ ^##[[:space:]]+Phase ]]; then
            current_phase="$line"
        fi

        # Track section headers (### X.X Name)
        if [[ "$line" =~ ^###[[:space:]] ]]; then
            current_section="$line"
        fi

        # Find first unchecked item in a table row
        if [[ "$line" =~ \|[[:space:]]*\[[[:space:]]\][[:space:]]*\| ]]; then
            # Extract the stage name (first column after |)
            next_stage=$(echo "$line" | sed 's/^| *\([^|]*\)|.*/\1/' | xargs)
            next_task="$current_section"
            break
        fi
    done < "$PLAN_FILE"

    if [[ -z "$next_task" ]]; then
        idx=$((RANDOM % ${#EMPTY[@]}))
        echo -e "${GREEN}${EMPTY[$idx]}${NC}"
        echo ""
        echo "All tasks in $PLAN_FILE are complete!"
        echo -e "${MAGENTA}Completed $((pass_count - 1)) passes before finishing.${NC}"
        exit 0
    fi

    idx=$((RANDOM % ${#WORKING[@]}))
    echo -e "${MAGENTA}${WORKING[$idx]}${NC}"
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}$current_phase${NC}"
    echo -e "${YELLOW}$next_task${NC}"
    echo -e "${NC}Stage: ${RED}$next_stage${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Show the relevant table
    in_section=0
    while IFS= read -r line; do
        if [[ "$line" == "$next_task" ]]; then
            in_section=1
            continue
        fi
        if [[ $in_section -eq 1 ]]; then
            if [[ "$line" =~ ^### ]] || [[ "$line" =~ ^## ]]; then
                break
            fi
            if [[ "$line" =~ ^\| ]]; then
                # Highlight the current row
                if [[ "$line" =~ \[[[:space:]]\] ]]; then
                    echo -e "${YELLOW}$line${NC}"
                else
                    echo "$line"
                fi
            fi
        fi
    done < "$PLAN_FILE"

    echo ""

    # Build the prompt for Claude
    RALPH_PROMPT="You are working through the plan file $PLAN_FILE. Your current task is:

Phase: $current_phase
Section: $next_task
Stage: $next_stage

Read $PLAN_FILE and the documentation it mentions for your current phase.
Work on this specific stage. When you have completed it:
1. Mark it complete in the plan file by changing [ ] to [x] in the appropriate table row
2. Then quit using /quit

Do not continue to other tasks - complete only this one stage and then quit."

    echo -e "${MAGENTA}Calling Claude to do the task...${NC}"
    echo "$RALPH_PROMPT"
    echo "$RALPH_PROMPT" | claude --model opus --print --verbose --allowedTools Edit "Bash(git:*)" "Bash(go:*)"

    echo ""
    idx=$((RANDOM % ${#DONE_QUOTES[@]}))
    echo -e "${GREEN}${DONE_QUOTES[$idx]}${NC}"
    echo ""
done

echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}Reached maximum of $MAX_PASSES passes. Run again for more!${NC}"
echo -e "${YELLOW}\"I'm tired. My brain needs a juice box.\"${NC}"
